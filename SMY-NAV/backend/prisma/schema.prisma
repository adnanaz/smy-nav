// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum definitions
enum UserRole {
  super_admin
  admin
  agent
  participant
}

enum AgencyStatus {
  active
  suspended
  inactive
}

enum ParticipantStatus {
  draft
  submitted
  verified
  waiting_quota
  sent_to_center
  waiting_dispatch
  completed
  rejected
}

enum BatchStatus {
  forming
  ready
  sent_to_center
  in_training
  completed
  cancelled
}

enum PaymentOption {
  pay_now
  pay_later
}

// Models
model Agency {
  id               String        @id @default(uuid()) @db.Uuid
  name             String        @db.VarChar(255)
  code             String        @unique @db.VarChar(50)
  email            String        @unique @db.VarChar(255)
  phone            String?       @db.VarChar(20)
  address          String?       @db.Text
  contactPerson    String?       @map("contact_person") @db.VarChar(255)
  status           AgencyStatus  @default(active)
  maxParticipants  Int           @default(100) @map("max_participants")
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  users        User[]
  participants Participant[]

  @@map("agencies")
}

model User {
  id            String    @id @default(uuid()) @db.Uuid
  agencyId      String?   @map("agency_id") @db.Uuid
  username      String    @unique @db.VarChar(100)
  email         String    @unique @db.VarChar(255)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  fullName      String    @map("full_name") @db.VarChar(255)
  role          UserRole
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login") @db.Timestamptz
  emailVerified Boolean   @default(false) @map("email_verified")
  
  // Additional fields for participant registration
  phone                String?   @db.VarChar(20)
  birthDate            DateTime? @map("birth_date") @db.Date
  occupation           String?   @db.VarChar(255)
  company              String?   @db.VarChar(255)
  interestedProgram    String?   @map("interested_program") @db.VarChar(255)
  source               String?   @db.VarChar(100) // How they found SMY
  registrationDate     DateTime? @map("registration_date") @db.Timestamptz
  registrationType     String?   @map("registration_type") @db.VarChar(50) // 'walk-in', 'agency', 'referral'
  
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations (simplified)
  agency              Agency?         @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  createdParticipants Participant[]   @relation("ParticipantCreator")
  approvedPayments    Participant[]   @relation("PaymentApprover")
  rejectedPayments    Participant[]   @relation("PaymentRejecter")
  createdBatches      TrainingBatch[]
  createdSchedules    TrainingSchedule[] @relation("ScheduleCreator")
  assignedSchedules   ScheduleParticipant[] @relation("ScheduleAssigner")
  activityLogs        ActivityLog[]

  @@index([agencyId])
  @@index([email])
  @@index([role])
  @@map("users")
}

model Participant {
  id                   String            @id @default(uuid()) @db.Uuid
  agencyId             String            @map("agency_id") @db.Uuid
  createdBy            String            @map("created_by") @db.Uuid
  batchId              String?           @map("batch_id") @db.Uuid // Add batch reference
  
  // Personal Information
  fullName             String            @map("full_name") @db.VarChar(255)
  nik                  String?           @unique @map("nik") @db.VarChar(50) // Made nullable for agency submissions
  email                String?           @db.VarChar(255)
  phone                String?           @db.VarChar(20)
  birthDate            DateTime?         @map("birth_date") @db.Date // Made nullable for agency submissions
  birthPlace           String?           @map("birth_place") @db.VarChar(255)
  gender               String?           @db.VarChar(10)
  address              String?           @db.Text
  
  // Training Information
  trainingProgram      String            @map("training_program") @db.VarChar(255)
  registrationNumber   String            @unique @map("registration_number") @db.VarChar(100)
  
  // Status & Progress
  status               ParticipantStatus @default(draft)
  currentProgressStep  Int               @default(1) @map("current_progress_step")
  progressPercentage   Decimal           @default(0.00) @map("progress_percentage") @db.Decimal(5, 2)
  notes                String?           @db.Text
  
  // Documents stored as JSON (simpler approach)
  documents            Json?             @db.JsonB
  
  // Payment Information
  paymentOption        PaymentOption?    @map("payment_option")
  paymentProof         Json?             @map("payment_proof") @db.JsonB // Store current payment proof document info
  paymentStatus        String?           @default("pending") @map("payment_status") @db.VarChar(50) // pending, approved, rejected, resubmitted
  paymentVersion       Int?              @default(1) @map("payment_version") // Current version number
  paymentHistory       Json[]            @default([]) @map("payment_history") @db.JsonB // Array of payment attempts
  adminNotes           String?           @map("admin_notes") @db.Text // Current admin notes
  paymentApprovedAt    DateTime?         @map("payment_approved_at") @db.Timestamptz
  paymentApprovedBy    String?           @map("payment_approved_by") @db.Uuid
  paymentRejectedAt    DateTime?         @map("payment_rejected_at") @db.Timestamptz
  paymentRejectedBy    String?           @map("payment_rejected_by") @db.Uuid
  
  // Timestamps
  submittedAt          DateTime?         @map("submitted_at") @db.Timestamptz
  approvedAt           DateTime?         @map("approved_at") @db.Timestamptz
  completedAt          DateTime?         @map("completed_at") @db.Timestamptz
  createdAt            DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  // Relations (simplified)
  agency              Agency                @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  creator             User                  @relation("ParticipantCreator", fields: [createdBy], references: [id])
  batch               TrainingBatch?        @relation(fields: [batchId], references: [id])
  approvedBy          User?                 @relation("PaymentApprover", fields: [paymentApprovedBy], references: [id])
  rejectedBy          User?                 @relation("PaymentRejecter", fields: [paymentRejectedBy], references: [id])
  scheduleAssignments ScheduleParticipant[] // Many-to-many dengan schedules
  activityLogs        ActivityLog[]

  @@index([agencyId])
  @@index([status])
  @@index([nik])
  @@index([createdBy])
  @@index([batchId])
  @@index([registrationNumber])
  @@map("participants")
}

model TrainingBatch {
  id                   String      @id @default(uuid()) @db.Uuid
  batchNumber          String      @unique @map("batch_number") @db.VarChar(50) // BST-2025-001
  trainingProgram      String      @map("training_program") @db.VarChar(50)
  year                 Int         @default(2025)
  sequenceNumber       Int         @map("sequence_number") // 1, 2, 3 untuk angkatan ke-
  status               BatchStatus @default(forming)
  minParticipants      Int         @default(15) @map("min_participants")
  maxParticipants      Int         @default(24) @map("max_participants")
  currentParticipants  Int         @default(0) @map("current_participants")
  targetStartDate      DateTime?   @map("target_start_date") @db.Date
  actualStartDate      DateTime?   @map("actual_start_date") @db.Date
  completionDate       DateTime?   @map("completion_date") @db.Date
  notes                String?     @db.Text
  createdAt            DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime    @updatedAt @map("updated_at") @db.Timestamptz
  createdBy            String?     @map("created_by") @db.Uuid

  // Relations
  participants         Participant[]
  creator              User?         @relation(fields: [createdBy], references: [id])

  @@index([trainingProgram, year])
  @@index([status])
  @@index([batchNumber])
  @@map("training_batches")
}

model ActivityLog {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String?   @map("user_id") @db.Uuid
  participantId String?   @map("participant_id") @db.Uuid
  agencyId      String?   @map("agency_id") @db.Uuid
  
  action        String    @db.VarChar(100)
  entityType    String    @map("entity_type") @db.VarChar(50)
  entityId      String?   @map("entity_id") @db.Uuid
  description   String?   @db.Text
  metadata      Json?     @db.JsonB
  ipAddress     String?   @map("ip_address") @db.Inet
  userAgent     String?   @map("user_agent") @db.Text
  
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user        User?        @relation(fields: [userId], references: [id])
  participant Participant? @relation(fields: [participantId], references: [id])

  @@index([userId])
  @@index([participantId])
  @@index([createdAt])
  @@map("activity_logs")
}

model TrainingSchedule {
  id                   String    @id @default(uuid()) @db.Uuid
  trainingProgram      String    @map("training_program") @db.VarChar(50) // BST, SAT, etc
  scheduleName         String    @map("schedule_name") @db.VarChar(255) // ex: "BST Batch 1 - January 2025"
  
  // Schedule Details
  startDate            DateTime  @map("start_date") @db.Date
  endDate              DateTime  @map("end_date") @db.Date
  startTime            String?   @map("start_time") @db.VarChar(10) // "08:00"
  endTime              String?   @map("end_time") @db.VarChar(10) // "17:00"
  
  // Location & Mode
  mode                 String    @default("offline") @db.VarChar(20) // online, offline, hybrid
  location             String?   @db.Text // Physical location for offline/hybrid
  onlineLink           String?   @map("online_link") @db.Text // Meeting link for online/hybrid
  
  // Additional Information
  dressCode            String?   @map("dress_code") @db.Text
  requirements         String?   @db.Text // Bawa laptop, alat tulis, etc
  contactPerson        String?   @map("contact_person") @db.VarChar(255)
  contactPhone         String?   @map("contact_phone") @db.VarChar(20)
  
  // Capacity Management
  maxParticipants      Int       @default(24) @map("max_participants") // Default 24 siswa per kelas
  currentParticipants  Int       @default(0) @map("current_participants") // Jumlah siswa saat ini
  
  // Reminders (for future notification feature)
  reminderDays         Int[]     @default([7, 3, 1]) @map("reminder_days") // H-7, H-3, H-1
  
  // Status and Metadata
  isActive             Boolean   @default(true) @map("is_active")
  notes                String?   @db.Text
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  createdBy            String?   @map("created_by") @db.Uuid

  // Relations
  creator              User?                    @relation("ScheduleCreator", fields: [createdBy], references: [id])
  participants         ScheduleParticipant[]   // Many-to-many dengan participants

  @@index([trainingProgram])
  @@index([startDate])
  @@index([isActive])
  @@map("training_schedules")
}

// Junction table untuk many-to-many relationship antara schedule dan participant
model ScheduleParticipant {
  id            String            @id @default(uuid()) @db.Uuid
  scheduleId    String            @map("schedule_id") @db.Uuid
  participantId String            @map("participant_id") @db.Uuid
  assignedAt    DateTime          @default(now()) @map("assigned_at") @db.Timestamptz
  assignedBy    String?           @map("assigned_by") @db.Uuid // Admin yang assign
  status        String            @default("assigned") @db.VarChar(50) // assigned, attended, absent
  notes         String?           @db.Text

  // Relations
  schedule      TrainingSchedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  participant   Participant       @relation(fields: [participantId], references: [id], onDelete: Cascade)
  assigner      User?             @relation("ScheduleAssigner", fields: [assignedBy], references: [id])

  @@unique([scheduleId, participantId]) // Prevent duplicate assignments
  @@index([scheduleId])
  @@index([participantId])
  @@map("schedule_participants")
}

model SystemSetting {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       String?  @db.Text
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@map("system_settings")
}